<hsm-state name="Processing" parallel="true">
  <!-- listen for player movement room-to-room -->
  <hsm-state game-listener="roomChange" hsm-enter="roomChange.listen('player', 'x-rel')" hsm-exit="roomChange.silence()">
    <hsm-state name="RoomWatching">
      <hsm-event on="roomChange" when="$evt.data.prop=='objects-whereabouts'" run="map.changeRoom($evt.data.next.id)" goto="RoomLoading"></hsm-event>
    </hsm-state>
    <hsm-state name="RoomLoading" hsm-enter="mem.resolver= $evt.resolve()" ng-init="mem={}">
      <hsm-event on="map-unchanged" run="mem.resolver()" goto="RoomWatching"></hsm-event>
      <hsm-event on="player-created" run="mem.resolver()" goto="RoomWatching"></hsm-event>
    </hsm-state>
  </hsm-state>
  <!--  the default text handler, always active, stores the lines in global memory, primarily for the the sake of the console. FIX: rework to capture into the console directly.-->
  <hsm-state game-listener="printText" hsm-enter="printText.listen('*', ['print', 'say'])" hsm-exit="printText.silence()" print-control="printer">
    <hsm-event on="printText" run="printer.addLines($evt.tgt, $evt.data).then($evt.resolve())"></hsm-event>
  </hsm-state>
  <!-- characters saying dialog -->
  <hsm-state hsm-init="constant('Talk') ? 'TalkEnabled':'TalkDisabled'">
    <hsm-state name="TalkDisabled">
    </hsm-state>
    <hsm-state name="TalkEnabled" game-listener="speech" hsm-enter="speech.listen('*', 'say')" hsm-exit="speech.silence()">
      <hsm-state talk-control="speaker" hsm-exit="speaker.cleanup('exit')">
        <hsm-state>
          <hsm-event on="speech" goto="Speaking" run="speaker.say($evt.tgt, $evt.data).then($evt.resolve())"></hsm-event>
          <hsm-event on="invWin-hack" goto="Speaking" run="speaker.say('player', $evt.msg)"></hsm-event>
        </hsm-state>
        <hsm-state name="Speaking">
          <hsm-event on="talk-dismiss" when="!speaker.finished()" goto="" run="speaker.next()"></hsm-event>
          <hsm-event on="talk-dismiss" goto="TalkEnabled" run="speaker.cleanup('finished')"></hsm-event>
          <hsm-event on="speaker-error" goto="TalkEnabled" run="speaker.cleanup($evt.reason)"></hsm-event>
          <hsm-event on="keys" when="$evt.escapeKey(true) || $evt.actionKey(true)" run="modal.dismiss()" goto=""></hsm-event>
        </hsm-state>
      </hsm-state>
    </hsm-state>
  </hsm-state>
  <!-- xxxx: move to story state file.
  when we are zoomed in to a sub-scene in the automat and sam opens the door, zoom out. -->
  <hsm-state game-listener="samOpenedDoor" hsm-enter="samOpenedDoor.listen('*', 'door-staging-two')" hsm-exit="samOpenedDoor.silence()">
    <hsm-state door-delay-control="doorDelay">
      <hsm-event on="samOpenedDoor" when="map.currLoc().room=='automat'" run="doorDelay.changeRoom('automat', 750).then($evt.resolve())"></hsm-event>
    </hsm-state>
  </hsm-state>
  <!-- xxxx: move to story state file.
   zoom to the hatch door. -->
  <hsm-state game-listener="boyOpenedDoor" hsm-enter="boyOpenedDoor.listen('alien-boy', 'yanking-open')" hsm-exit="boyOpenedDoor.silence()">
    <hsm-event on="boyOpenedDoor" when="$evt.tgt='automat-tunnel-door'" run="map.changeView('hatch').then($evt.resolve())"></hsm-event>
  </hsm-state>
  <!-- handle title text -->
  <hsm-state game-listener="reading" hsm-enter="reading.listen('*', 'reporting-read', true)" hsm-exit="reading.silence()">
    <hsm-state name="Entitlement">
      <hsm-event on="reading" when="$evt.start" run="dialog.setTitle($evt.tgt)" goto="NeedGreeting"></hsm-event>
    </hsm-state>
    <hsm-state name="NeedGreeting" game-listener="greeting" hsm-enter="greeting.listen('player', 'being-greeted-by')" hsm-exit="greeting.silence()">
      <hsm-event on="greeting" goto="Reading"></hsm-event>
      <hsm-event on="reading" when="$evt.end" goto="Entitlement" run="dialog.setTitle()"></hsm-event>
    </hsm-state>
    <hsm-state name="Reading" game-listener="converse" hsm-enter="converse.listen('conversation', 'x-rel')" hsm-exit="converse.silence()">
      <hsm-event on="converse" when="!$evt.data.next" run="dialog.setTitle()" goto="Entitlement"></hsm-event>
    </hsm-state>
  </hsm-state>
  <hsm-state game-listener="savingGame" hsm-enter="savingGame.listen('player', 'saving-it')" hsm-exit="savingGame.silence()">
    <hsm-state game-listener="storyText" hsm-enter="storyText.listen('_display_', 'print')" hsm-exit="storyText.silence()" hsm-init="'Playback'">
      <!-- handle unexpected save responses ( ex. coming from the console ) -->
      <hsm-event on="savingGame" goto="UnexpectedSave"></hsm-event>
      <hsm-state name="UnexpectedSave" ng-init="mem={}" hsm-enter="mem.saveType=$evt.ctx.id">
        <hsm-event on="storyText" run="save.unexpected(mem.saveType, $evt.data).then($evt.resolve())" goto="Playback"></hsm-event>
      </hsm-state>
      <hsm-state name="Playback">
        <!-- handle story text -->
        <hsm-state game-listener="reportView" hsm-enter="reportView.listen('*', 'reporting-the-view', true)" hsm-exit="reportView.silence()">
          <hsm-state game-listener="comments" hsm-enter="comments.listen('player', 'printing-conversation-choices', true)" hsm-exit="comments.silence()">
            <hsm-state game-listener="vending" hsm-enter="vending.listen('vending-machine',
        'offering-vendibles', true)" hsm-exit="vending.silence()">
              <hsm-state game-listener="departing" hsm-enter="departing.listen('*', 'departing', true)" hsm-exit="departing.silence()">
                <!--  -->
                <hsm-state name="StoryText" hsm-init="constant('Popups') ? 'PopupsEnabled' : 'PopupsDisabled'">
                  <hsm-state name="PopupsDisabled">
                  </hsm-state>
                  <!-- regular story text popups -->
                  <hsm-state name="PopupsEnabled" popup-control="popup">
                    <hsm-state>
                      <hsm-event on="storyText" goto="PopupDisplayed" run="popup.open('popupBox', $evt.data).then($evt.resolve())"></hsm-event>
                    </hsm-state>
                    <hsm-state name="PopupDisplayed" hsm-exit="popup.close('exit')">
                      <hsm-event on="popup-box-closed" goto="PopupsEnabled"></hsm-event>
                      <hsm-event on="popup-box-dismiss" run="popup.close($evt.reason)"></hsm-event>
                      <hsm-event on="keys" when="$evt.escapeKey(true) || $evt.actionKey(true)" run="modal.dismiss()" goto=""></hsm-event>
                    </hsm-state>
                  </hsm-state>
                  <!--  -->
                  <hsm-event on="comments" goto="CaptureComments"></hsm-event>
                  <hsm-event on="vending" goto="CaptureVendibles"></hsm-event>
                  <!-- handle player dialog choices -->
                  <hsm-state name="CaptureComments" game-listener="offers" hsm-enter="offers.listen('*', 'being-offered')" hsm-exit="offers.silence()">
                    <hsm-event on="comments" when="$evt.end" goto="StoryText"></hsm-event>
                    <hsm-state name="AwaitQuip">
                      <hsm-event on="offers" goto="AwaitComment" run="dialog.addQuip($evt.tgt)"></hsm-event>
                    </hsm-state>
                    <hsm-state name="AwaitComment">
                      <hsm-event on="storyText" goto="AwaitQuip" run="dialog.addChoice($evt.data)"></hsm-event>
                    </hsm-state>
                  </hsm-state>
                  <!-- vendible choices -->
                  <hsm-state name="CaptureVendibles" game-listener="offers" hsm-enter="offers.listen('*', 'being-offered')" hsm-exit="offers.silence()">
                    <hsm-event on="vending" when="$evt.end" goto="StoryText" run="dialog.addFallback('0', 'Never mind.')"></hsm-event>
                    <hsm-state name="AwaitVendingQuip">
                      <hsm-event on="offers" goto="AwaitVendingComment" run="dialog.addQuip($evt.tgt)"></hsm-event>
                    </hsm-state>
                    <hsm-state name="AwaitVendingComment">
                      <hsm-event on="storyText" goto="AwaitVendingQuip" run="dialog.addChoice($evt.data)"></hsm-event>
                    </hsm-state>
                  </hsm-state>
                  <!-- room entry prints nothing-->
                  <hsm-event on="reportView" goto="SilenceRoomEntryText"></hsm-event>
                  <hsm-state name="SilenceRoomEntryText">
                    <hsm-event on="reportView" when="$evt.end" goto="StoryText"></hsm-event>
                  </hsm-state>
                  <!-- quiet "the actor says goodbye" 
                  except this is silencing all text that falls inside of the departing event.
                  ( ex. returning items )
                  FIX: i hacked sashimi to turn off the message. the correct fix involves the fact before and after actions dont really fall before/after the scope, and they probably should.
                  <hsm-event on="departing" goto="SilenceDepartingText"></hsm-event>
                  <hsm-state name="SilenceDepartingText">
                    <hsm-event on="departing" when="$evt.end" goto="StoryText"></hsm-event>
                  </hsm-state>
                  -->
                </hsm-state>
              </hsm-state>
            </hsm-state>
          </hsm-state>
        </hsm-state>
      </hsm-state>
    </hsm-state>
  </hsm-state>
</hsm-state>
