<!-- player controller their avatar -->
<hsm-state name="PlayTurn" hsm-init="modal.showing() && 'SharedModal'" hsm-enter="turn.start()" hsm-exit="turn.end()" custom-actions-control="customActions">
  <!-- multiple sources for this, action bar, inventory window; awe usually get pulled out to process the results -->
  <hsm-event on="actions-run" when="customActions.handles($evt)" run="customActions.run($evt)" goto="SharedPlay"></hsm-event>
  <hsm-event on="actions-run" run="game.post($evt.pack())" goto="SharedPlay"></hsm-event>
  <!--  -->
  <hsm-event on="close-button-click" goto="AppExit"></hsm-event>
  <hsm-state name="SharedPlay" hsm-enter="settingsButton.enable()" hsm-exit="settingsButton.enable(false)">
    <!-- keep updating the player (drawing) so that facing changes as we open the menu work; basically there's a one frame timing issue b/t requesting facing, and drawing the change -->
    <hsm-event on="update-game" run="player.update($evt.dt)"></hsm-event>
    <hsm-state></hsm-state>
    <!--  -->
    <hsm-event on="action-bar-opened" goto="SharedActions"></hsm-event>
    <hsm-state name="SharedActions" hsm-exit="actionBar.close('exit')">
      <hsm-event on="modal-opened" goto=""></hsm-event>
      <hsm-event on="action-bar-closed" goto="SharedPlay"></hsm-event>
      <!-- fix: how to handle errors?  -->
      <hsm-event on="action-bar-zoom" goto="SharedPlay" run="map.changeView($evt.view)"></hsm-event>
      <!--  -->
      <hsm-event on="action-bar-dismiss" run="actionBar.close($evt.reason)"></hsm-event>
      <hsm-event on="keys" when="$evt.escapeKey()" run="actionBar.close('escape')"></hsm-event>
      <hsm-event on="keys" goto=""></hsm-event>
    </hsm-state>
    <!-- ^~SharedActions -->
  </hsm-state>
  <!-- ^~SharedPlay -->
  <ng-include src="'settings.html'"></ng-include>
  <ng-include src="'exiting.html'"></ng-include>
  <!--  shared modal handles user initiated dialogs -->
  <hsm-event on="modal-opened" goto="SharedModal"></hsm-event>
  <hsm-state name="SharedModal" mouse-hide-control="mmodal" hsm-enter="mmodal.hide()" hsm-exit="mmodal.show()">
    <hsm-event on="modal-closed" run="log.info('shared modal closed', $evt.source, $evt.reason)" goto="SharedPlay"></hsm-event>
  </hsm-state>
</hsm-state>
