<!-- mouse input tweaks the cursor, and raises events which effect player control. -->
<hsm-state name="Hover" hsm-init="mouse.inBounds() ? 'InBounds' : 'OutOfBounds'">
  <hsm-state name="OutOfBounds" hsm-enter="mouse.show(false)">
    <hsm-event on="mouseenter" goto="InBounds"></hsm-event>
    <hsm-event on="mousemove" goto="InBounds"></hsm-event>
  </hsm-state>
  <hsm-state name="InBounds" hsm-exit="mouse.show(false)">
    <hsm-event on="mouseleave" goto="OutOfBounds"> </hsm-event>
    <hsm-event on="flash-cursor" goto="MouseFlash"> </hsm-event>
    <hsm-event on="vanish-cursor" goto="MouseVanish"> </hsm-event>
    <!-- now wait for mouse down -->
    <hsm-state name="MouseHighlight" hsm-enter="mouseTarget.reset()">
      <hsm-event on="mousedown" goto="MouseWait"> </hsm-event>
      <hsm-state>
        <!-- note: because the avatar can move, we have to check every frame. -->
        <hsm-event on="ga-update" when="mouseTarget()" run="!avatar.onLandingPads(mouseTarget()) ? mouse.show('disk') : mouse.show('bullseye')"> </hsm-event>
        <hsm-event on="mouseTargetChanged" when="!$evt.target" run="mouse.show('pointer')"></hsm-event>
      </hsm-state>
      <!-- change the cursor into a different cursor for a short period of time -->
      <hsm-state name="MouseFlash" hsm-enter="mouse.show($evt)" hsm-exit="mouse.show('pointer')">
        <hsm-state ga-timeout="flash" hsm-enter="flash.timeout(200,'flash-out')" hsm-exit="flash.cancel()">
          <!-- <hsm-event on="mousemove" goto="MouseHighlight"></hsm-event> -->
          <hsm-event on="flash-out" goto="MouseHighlight"></hsm-event>
        </hsm-state>
      </hsm-state>
      <!-- hide the cursor until its moved -->
      <hsm-state name="MouseVanish" hsm-enter="mouse.show(false)" hsm-exit="mouse.show('pointer')">
        <hsm-event on="mousemove" goto="MouseHighlight"></hsm-event>
        <hsm-event on="reveal-cursor" goto="MouseHighlight"></hsm-event>
      </hsm-state>
    </hsm-state>
    <hsm-state name="MouseWait" ga-timeout="wait" hsm-enter="wait.timeout(150,'wait-timeout')" hsm-exit="wait.cancel()">
      <hsm-event on="mouseup" run="log.info('MouseWait: mouseup')"></hsm-event>
      <hsm-event on="direct" run="log.info('MouseWait: direct')"></hsm-event>
      <hsm-event on="wait-timeout" run="log.info('MouseWait: wait')"></hsm-event>
      <!--  -->
      <hsm-event on="direct" goto="MouseDirect"></hsm-event>
      <!-- <hsm-event on="approach" goto="MouseHighlight"></hsm-event> -->
      <hsm-event on="approach" run="machine.emit('flash-cursor', mouseTarget() ? 'bullseye' : 'arrow')"></hsm-event>
      <!-- on timeout or drag, begin a directed move -->
      <!-- <hsm-event on="app-dragstart" run="avatar.direct()"> </hsm-event> -->
      <hsm-event on="wait-timeout" run="avatar.direct()"> </hsm-event>
      <!-- on mouse up within time - ie. a click - the player selects the target -->
      <hsm-event on="mouseup" run="avatar.approach(mouseTarget(), mouse.pos())"></hsm-event>
    </hsm-state>
    <!-- while directing, the cursor changes to a chevron (➢) for surface points, or a down arrow (↓) for subjects; note: even points on a collision surface are accepted. -->
    <hsm-state name="MouseDirect" hsm-enter="mouseTarget.reset()" hsm-exit="mouse.show('pointer')">
      <hsm-event on="mouseup" goto="MouseHighlight"></hsm-event>
      <hsm-event on="mouseTargetChanged" run="$evt.target ?'MouseDirectTarget' :'MouseDirectPos'"></hsm-event>
      <hsm-event on="move-arrived" goto="MouseDirectDefault"></hsm-event>
      <hsm-state name="MouseDirectDefault" hsm-enter="!avatar.onLandingPads($evt.target) ? mouse.show('pointer') : mouse.show('bullseye')">
        <hsm-event on="mousemove" goto="MouseDirectPos"></hsm-event>
      </hsm-state>
      <hsm-state name="MouseDirectPos" hsm-enter="mouse.show('chev')" hsm-exit="mouse.setAngle()">
        <hsm-event on="ga-update" run="mouse.setAngle(avatar.getCenter())"> </hsm-event>
      </hsm-state>
      <hsm-state name="MouseDirectTarget" hsm-enter="mouse.show('arrow')">
      </hsm-state>
    </hsm-state>
  </hsm-state>
</hsm-state>
