<hsm-state name="Physics" physics-control="physics" hsm-enter="physics.create(map.get('physics'))" hsm-exit="physics.destroy()">
    <hsm-state action-bar-control="actionBar" hsm-enter="actionBar.bindTo('gameMap')" hsm-exit="actionBar.destroy()">
      <hsm-state name="PhysicsReady" avatar-control="avatar" hsm-enter="avatar.create(player.linkup(), physics, 12)" hsm-exit="avatar.destroy()" hsm-init="stream.processing() ? 'PhysicsPause' : 'PhysicsPlay'" hsm-exit="pads.destroy()">
        <!--  -->
        <hsm-event on="player-direct" goto="Directing"></hsm-event>
        <!-- might "beep" when not on pads -->
        <hsm-event on="player-approach" when="!avatar.touches($evt.target)" goto="Pathing"></hsm-event>
        <hsm-event on="player-approach" run="player.interact($evt.target)"></hsm-event>
        <!--  -->
        <hsm-event on="player-interact" run="$log.info('player-interact')"></hsm-event>
        <hsm-event on="player-interact" when="!avatar.touches($evt.target)" goto="Planning"></hsm-event>
        <hsm-event on="player-interact" run="actionBar.open($evt.target, combiner.item())"></hsm-event>
        <!--  -->
        <hsm-event on="hover-select" run="avatar.faceTarget($evt.target, $evt.pos)"></hsm-event>
        <hsm-event on="hover-highlight" run="mouse.show( !$evt.target ? 'pointer' : (!avatar.touches($evt.target) ? 'disk' : 'bullseye'))"></hsm-event>
        <!--  -->
        <hsm-event on="keys" when="$evt.moveKey(true)" goto="KeyWalking"></hsm-event>
        <hsm-event on="modal-opened" goto="PhysicsModal"></hsm-event>
        <!--  -->
        <hsm-state name="PhysicsPlay" hsm-enter="log.info('physics playing')">
          <!-- disabled the keyboard action key. need a real location for every target to center the menu. <hsm-event on="keys" when="$evt.keydown && $evt.actionKey()" run="player.interact( pads.closestLanding(chara.getFeet()))"></hsm-event> -->
          <hsm-event on="update-game" run="physics.step($evt.dt)"></hsm-event>
          <!--  -->
          <hsm-state name="Planning">
            <hsm-event on="keys" when="$evt.moveKey(true)" goto="KeyWalking"> </hsm-event>
          </hsm-state>
          <!--  -->
          <hsm-state name="Moving" hsm-exit="avatar.stop()">
            <hsm-event on="update-game" run="avatar.update($evt.dt)"></hsm-event>
            <hsm-event on="keys" when="$evt.escapeKey()" goto="Planning"></hsm-event>
            <hsm-state name="KeyWalking" hsm-enter="machine.emit('vanish-cursor')" hsm-exit="machine.emit('reveal-cursor')">
              <hsm-event on="keys" when="!keys.moving()" goto="Planning"></hsm-event>
              <hsm-event on="keys" when="$evt.moveKey(true)" goto=""></hsm-event>
            </hsm-state>
            <hsm-state>
              <ng-include src="'pathing.html'"></ng-include>
              <ng-include src="'directing.html'"></ng-include>
            </hsm-state>
          </hsm-state>
        </hsm-state>
        <hsm-state name="PhysicsModal" hsm-enter="log.info('physics modaling')" hsm-exit="modal.dismiss($evt.name)">
          <hsm-event on="modal-closed" goto="PhysicsReady"></hsm-event>
        </hsm-state>
        <!--  -->
        <hsm-event on="stream-processing" goto="PhysicsPause"></hsm-event>
        <hsm-state name="PhysicsPause" hsm-enter="log.info('physics paused')">
          <hsm-event on="stream-empty" goto="PhysicsReady"></hsm-event>
        </hsm-state>
      </hsm-state>
    </hsm-state>
</hsm-state>
