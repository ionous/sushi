<hsm-state name="Physics" physics-control="physics" hsm-enter="physics.create(map.get('physics'))" hsm-exit="physics.destroy()">
  <hsm-state action-bar-control="actionBar" hsm-enter="actionBar.bindTo('gameMap')" hsm-exit="actionBar.destroy()">
    <hsm-state name="PhysicsReady" avatar-control="avatar" hsm-enter="avatar.create(player.linkup(), physics, 12)" hsm-exit="avatar.destroy()" hsm-init="stream.processing() ? 'PhysicsPause' : (modal.showing() ? 'PhysicsModal' : 'PhysicsPlay')" hsm-exit="pads.destroy()">
      <!--  -->
      <hsm-event on="modal-opened" when="$evt.matches('actionBar')" goto="PhysicsActions"></hsm-event>
      <hsm-event on="modal-opened" goto="PhysicsModal"></hsm-event>
      <!--  -->
      <hsm-state name="PhysicsPlay" mouse-target="mouseTarget" hsm-enter="mouseTarget.bind(map, avatar)" hsm-exit="mouseTarget.release()">
        <hsm-event on="player-interact" when="!avatar.touches($evt.target)" goto="Planning"></hsm-event>
        <hsm-event on="player-interact" run="actionBar.open($evt.target, combiner.item())"></hsm-event>
        <!-- directing and planning both use mouse target to change the cursor apperance -->
        <hsm-event on="update-game" run="mouseTarget.update(mouse.pos())"></hsm-event>
        <!--  -->
        <hsm-event on="keys" when="$evt.moveKey(true)" goto="KeyWalking"></hsm-event>
        <!-- disabled the keyboard action key. need a real location for every target to center the menu. <hsm-event on="keys" when="$evt.keydown && $evt.actionKey()" run="player.interact( pads.closestLanding(chara.getFeet()))"></hsm-event> -->
        <hsm-event on="update-game" run="physics.step($evt.dt)"></hsm-event>
        <ng-include src="'directing.html'"></ng-include>
        <hsm-state name="MouseHovering" hsm-enter="mouse.show('pointer')">
          <!--  -->
          <hsm-event on="mouse-target-changed" run="mouse.show( !$evt.target ? 'pointer' : (!$evt.touches ? 'disk' : 'bullseye'))"></hsm-event>
          <!--  -->
          <hsm-event on="hover-press" when="mouseTarget()" run="avatar.lookAt(mouseTarget())"></hsm-event>
          <!-- FIX: might "beep" when not on pads -->
          <hsm-event on="hover-select" when="!avatar.touches(mouseTarget())" goto="Pathing"></hsm-event>
          <hsm-event on="hover-select" run="player.interact(mouseTarget())"></hsm-event>
          <hsm-event on="hover-direct" goto="Directing"></hsm-event>
          <!--  -->
          <hsm-state name="Planning">
            <hsm-event on="keys" when="$evt.moveKey(true)" goto="KeyWalking"> </hsm-event>
          </hsm-state>
          <ng-include src="'keyWalking.html'"></ng-include>
          <ng-include src="'pathing.html'"></ng-include>
          <hsm-state name="PhysicsActions" hsm-enter="mouseTarget.ghost(actionBar.target())" hsm-exit="mouseTarget.ghost(false)">
            <hsm-state hsm-exit="actionBar.dismiss($evt)">
              <!-- FIX? should probably move action bar away from modal. *sigh* -->
              <hsm-event on="modal-opened" when="$evt.matches('actionBar')" goto=""></hsm-event>
              <!-- action bar handling happens elsewhere, but we still allow hovering;
            if hover gets keys shortcuts, might look at how to include rename states -->
              <hsm-event on="modal-closed" goto="Planning"></hsm-event>
            </hsm-state>
          </hsm-state>
        </hsm-state>
      </hsm-state>
      <hsm-state name="PhysicsModal">
        <hsm-event on="modal-closed" goto="PhysicsReady"></hsm-event>
      </hsm-state>
      <!--  -->
      <hsm-event on="stream-processing" goto="PhysicsPause"></hsm-event>
      <hsm-state name="PhysicsPause">
        <hsm-event on="stream-empty" goto="PhysicsReady"></hsm-event>
      </hsm-state>
    </hsm-state>
  </hsm-state>
</hsm-state>
