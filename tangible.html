<hsm-state name="Tangible" physics-control="physics" hsm-enter="physics.create(map.get('physics'))" hsm-exit="physics.destroy()">
  <hsm-state landing-pad-control="pads" hsm-enter="pads.attach(map.get('pads'))" hsm-exit="pads.destroy()">
    <hsm-state action-bar="actionBar" hsm-enter="actionBar.bindTo(map)" hsm-exit="actionBar.destroy()">
      <hsm-state avatar-control="avatar" hsm-enter="avatar.create(player.linkup(), physics, 12)" hsm-exit="avatar.destroy()" hsm-init="stream.processsing() ? 'WaitingToRun' : 'PhysicsActive'" hsm-exit="pads.destroy()">
        <!--  -->
        <hsm-event on="avatar-direct" goto="Directing"></hsm-event>
        <!-- might "beep" when not on pads -->
        <hsm-event on="player-approach" run="pads.onLandingPads(avatar, $evt.target) ? avatar.interact($evt.target) : 'Pathing'"></hsm-event>
        <hsm-event on="player-interact" run="pads.onLandingPads(avatar, $evt.target)? actionBar.open($evt.target) : 'Planning'"></hsm-event>
        <hsm-event on="hover-select" run="avatar.faceTarget($evt.target, $evt.pos)"></hsm-event>
        <hsm-event on="hover-highlight" run="mouse.show( !$evt.target ? 'pointer' : (!pads.onLandingPads(avatar, $evt.target) ? 'disk' : 'bullseye'))"></hsm-event>
        <!--  -->
        <hsm-event on="keys" when="$evt.moveKey(true)" goto="KeyWalking"></hsm-event>
        <hsm-event on="modal-opened" run="log.info('modal-opened', $evt)"></hsm-event>
        <hsm-event on="modal-opened" when="$evt.source =='actionBar'" goto="ActionBarOpen"></hsm-event>
        <!--  -->
        <hsm-state name="PhysicsActive">
          <!-- disabled the keyboard action key. need a real location for every target to center the menu. <hsm-event on="keys" when="$evt.keydown && $evt.actionKey()" run="avatar.interact( pads.closestLanding(chara.getFeet()))"></hsm-event> -->
          <hsm-event on="update-game" run="physics.step($evt.dt)"></hsm-event>
          <hsm-state name="Planning">
            <hsm-event on="keys" when="$evt.moveKey(true)" goto="KeyWalking"> </hsm-event>
          </hsm-state>
          <hsm-state name="Moving" hsm-exit="avatar.stop()">
            <hsm-event on="update-game" run="avatar.update($evt.dt)"></hsm-event>
            <hsm-event on="keys" when="$evt.escapeKey()" goto="Planning"></hsm-event>
            <hsm-state name="KeyWalking" hsm-enter="machine.emit('vanish-cursor')" hsm-exit="machine.emit('reveal-cursor')">
              <hsm-event on="keys" when="!keys.moving()" goto="Planning"></hsm-event>
              <hsm-event on="keys" when="$evt.moveKey(true)" goto="''"></hsm-event>
            </hsm-state>
            <hsm-state>
              <ng-include src="'pathing.html'"></ng-include>
              <ng-include src="'directing.html'"></ng-include>
            </hsm-state>
          </hsm-state>
        </hsm-state>
        <hsm-state name="ActionBarOpen" hsm-exit="actionBar.dismiss($evt.name)">
          <!-- running actions handled at the GameIsActive level -->
          <hsm-event on="keys" when="$evt.escapeKey()" run="actionBar.dismiss('escape')"></hsm-event>
        </hsm-state>
        <!--  -->
        <hsm-state name="WaitingToRun">
          <hsm-event on="stream-empty" goto="PhysicsActive"></hsm-event>
        </hsm-state>
        <hsm-event on="stream-processing" goto="WaitingToRun"></hsm-event>
      </hsm-state>
    </hsm-state>
  </hsm-state>
</hsm-state>
