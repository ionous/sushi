<hsm-state name="Interact" ga-keys="keys" hsm-enter="keys.listen()" hsm-exit="keys.silence()">
  <hsm-event on="approach" run="avatar.onLandingPads($evt.target) ? avatar.interact($evt.target) : 'Pathing'"></hsm-event>
  <hsm-event on="direct" goto="Directing"></hsm-event>
  <!-- might "beep" when not on pads -->
  <hsm-event on="interact" when="avatar.onLandingPads($evt.target)" goto="ActionBarOpen"></hsm-event>
  <hsm-event on="mousedown" run="avatar.face(mouseTarget(), mouse.pos())"></hsm-event>
  <hsm-event on="ga-key" when="$evt.shiftKey()" run="avatar.walk($evt.keydown)"></hsm-event>
  <hsm-state name="ActionBarClosed">
    <!-- disabled the keyboard action key. need a real location for every target to center the menu. <hsm-event on="ga-key" when="$evt.keydown && $evt.actionKey()" run="avatar.interact( avatar.landing())"></hsm-event> -->
    <hsm-state name="Planning">
      <hsm-event on="ga-key" when="$evt.moveKey(true)" goto="KeyWalking"> </hsm-event>
    </hsm-state>
    <hsm-state name="Moving">
      <hsm-event on="update-game" run="avatar.update($evt.dt)"></hsm-event>
      <hsm-event on="ga-key" when="$evt.escapeKey()" goto="Planning"></hsm-event>
      <!--  -->
      <hsm-state name="KeyWalking" hsm-enter="avatar.nudge($evt.moveKey(), $evt.keydown)" hsm-exit="avatar.nudge(false)">
        <hsm-state hsm-enter="machine.emit('vanish-cursor')" hsm-exit="machine.emit('reveal-cursor')">
          <hsm-event on="ga-key" run="avatar.nudge($evt.moveKey(), $evt.keydown)"></hsm-event>
          <hsm-event on="ga-key" when="!$evt.moving()" goto="Planning"></hsm-event>
        </hsm-state>
      </hsm-state>
      <hsm-state>
        <hsm-event on="ga-key" when="$evt.moveKey(true)" goto="KeyWalking"></hsm-event>
        <ng-include src="'pathing.html'"></ng-include>
        <ng-include src="'directing.html'"></ng-include>
      </hsm-state>
    </hsm-state>
  </hsm-state>
  <hsm-state name="ActionBarOpen" action-bar="actionBar" hsm-enter="actionBar.createAt(map.get('mapEl'), $evt.target)" hsm-exit="actionBar.destroy()">
    <hsm-event on="ga-key" when="$evt.escapeKey()" goto="ActionBarClosed"></hsm-event>
    <hsm-event on="ga-key" when="$evt.moveKey(true)" goto="KeyWalking"></hsm-event>
    <hsm-event on="demo-action" goto="ActionBarClosed"></hsm-event>
    <hsm-event on="demo-zoom" goto="ActionBarClosed"></hsm-event>
  </hsm-state>
</hsm-state>
